# Scaibu MongoDB Infrastructure - Hyper-Fidelity API & Algorithms

This document details the hyper-fidelity implementation of 50+ MongoDB algorithms. Each algorithm is a multi-phase functional service that performs real state transitions and audits results via engine diagnostics.

## 1. Hyper-Fidelity Sequence Diagrams

### 1.1 Indexing & Query Optimization

#### B-Tree Index Algorithm (Audit & Validation)
```mermaid
sequenceDiagram
    participant API
    participant Algo as btree_index_algorithm
    participant DB
    
    API->>Algo: POST /algo/btree-index
    Algo->>DB: delete_many({}) (Prepare)
    Algo->>DB: insert_many(1000 docs) (Load)
    Algo->>DB: create_index(key) (Execute)
    Algo->>DB: command("explain", {filter}) (Audit)
    Algo->>DB: command("validate", coll) (DeepAudit)
    DB-->>Algo: {treeDepth, executionStats}
    Algo-->>API: {algorithm: "B-Tree", keysExamined, treeDepth}
```

#### Covered Query Optimization (Engine Path Proof)
```mermaid
sequenceDiagram
    participant API
    participant Algo as covered_query_optimization
    participant DB
    
    API->>Algo: POST /algo/covered-query
    Algo->>DB: command("explain", {filter, projection})
    DB-->>Algo: {totalDocsExamined: 0, totalKeysExamined: N}
    Algo-->>API: {covered: True, keysExamined: N}
```

### 1.2 Storage Engine & Distributed Systems

#### WiredTiger MVCC Concurrency (Isolation Verification)
```mermaid
sequenceDiagram
    participant API
    participant Algo as wiredtiger_mvcc_concurrency
    participant S1 as Session 1 (Write)
    participant S2 as Session 2 (Read)
    participant DB
    
    API->>Algo: POST /algo/wt-mvcc
    Algo->>S1: start_transaction()
    Algo->>S1: update_one(doc_id)
    Algo->>S2: find_one(doc_id)
    S2-->>Algo: Returns old version (MVCC Proof)
    Algo->>S1: commit_transaction()
    Algo-->>API: {mvcc: "WiredTiger", isolation: "snapshot"}
```

#### Raft Consensus & Election (Protocol Polling)
```mermaid
sequenceDiagram
    participant API
    participant Algo as raft_election_algorithm
    participant DB
    
    API->>Algo: POST /algo/raft-election
    Algo->>DB: command("replSetGetStatus")
    DB-->>Algo: {term, myState}
    Algo-->>API: {term, role: "PRIMARY/SECONDARY"}
```

#### Two-Phase Commit Coordinator (Log-Based State Machine)
```mermaid
sequenceDiagram
    participant API
    participant Algo as 2pc_coordinator
    participant DB as hf_2pc_log
    
    API->>Algo: POST /algo/2pc-coordinator
    Algo->>DB: insert({state: "PREPARE"})
    Algo->>DB: update({state: "COMMIT"})
    Algo->>DB: update({state: "DONE"})
    Algo-->>API: {tx_id, final_state: "DONE"}
```

### 1.3 Replication & Change Streams

#### Change Stream Resume Token (Event Lifecycle)
```mermaid
sequenceDiagram
    participant API
    participant Algo as resume_token_algorithm
    participant DB
    
    API->>Algo: POST /algo/resume-token
    Algo->>DB: watch() cursor
    Algo->>DB: insert_one() (Trigger Event)
    DB-->>Algo: Change Event object
    Algo-->>API: {token: _id}
```

## 2. Definitive Algorithm Category Mapping

All algorithms are implemented as 100% functional blocks in `mongodb_algorithms.py`.

| Category | Representative Endpoint | Verification Logic |
| :--- | :--- | :--- |
| **Indexing** | `/algo/btree-index` | Audits `treeDepth` via `validate` and `IXSCAN` via `explain`. |
| **Sharding** | `/algo/hash-sharding` | Executes live `shardCollection` on Admin DB. |
| **Query Engine** | `/algo/query-plan` | Extracts CBO (Cost-Based) planner winners and rejected plans. |
| **Aggregation** | `/algo/agg-optimize` | Proves `PipeRewriting` and `MatchProjectPushdown`. |
| **Consistency** | `/algo/causal-consistency` | Audits `cluster_time` tokens for causal ordering. |
| **Storage** | `/algo/journal-wal` | Extracts `journaledMB` from `serverStatus.dur`. |
| **Replication** | `/algo/oplog` | Tails `local.oplog.rs` for event sequence proof. |
| **Recovery** | `/algo/checkpoint` | Returns `checkpoints_total` from WiredTiger internals. |

---

## 3. Operations & Verification

Run the consolidated test suite (47 tests) for full engine-level verification:

```bash
export PYTHONPATH=$PYTHONPATH:$(pwd)
.venv/bin/python -m pytest infrastructure/database/mongodb/tests/test_algorithms.py
```

*Generated by Antigravity AI - Absolute Fidelity Engine*
