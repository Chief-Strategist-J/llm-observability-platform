version: "3.9"

services:
  mongodb:
    image: mongo:8.0
    container_name: mongodb-instance-0

    command:
      - "mongod"
      - "--auth"
      - "--bind_ip_all"
      - "--port"
      - "27017"
      - "--wiredTigerCacheSizeGB"
      - "0.5"

    environment:
      MONGO_INITDB_ROOT_USERNAME: "admin"
      MONGO_INITDB_ROOT_PASSWORD: "MongoPassword123!"
      MONGO_INITDB_DATABASE: "admin"
      INSTANCE_ID: "0"

    ports:
      - "27017:27017"

    volumes:
      - mongodb-data-0:/data/db
      - mongodb-config-0:/data/configdb

    networks:
      - data-network

    labels:
      traefik.enable: "false"

      prometheus.io.scrape: "true"
      prometheus.io.port: "9216"
      prometheus.io.path: "/metrics"

      loki.source: "docker"
      loki.job: "mongodb-0"

    deploy:
      resources:
        limits:
          memory: "1g"
          cpus: "1.0"
        reservations:
          memory: "512m"

    restart: unless-stopped

    healthcheck:
      test:
        [
          "CMD-SHELL",
          "mongosh --quiet --port 27017 --eval \"db.adminCommand('ping')\" --username admin --password MongoPassword123! --authenticationDatabase admin || exit 1"
        ]
      interval: "30s"
      timeout: "10s"
      retries: 3
      start_period: "40s"

volumes:
  mongodb-data-0:
  mongodb-config-0:

networks:
  data-network:
    external: true
