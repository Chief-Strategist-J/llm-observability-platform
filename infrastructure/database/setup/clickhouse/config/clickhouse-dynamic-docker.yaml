version: "3.9"

services:
  clickhouse:
    image: clickhouse/clickhouse-server:${CLICKHOUSE_IMAGE_TAG:-latest}
    container_name: clickhouse-instance-${CLICKHOUSE_INSTANCE_ID:-0}

    environment:
      CLICKHOUSE_DB: "${CLICKHOUSE_DB:-default}"
      CLICKHOUSE_USER: "${CLICKHOUSE_USER:-default}"
      CLICKHOUSE_PASSWORD: "${CLICKHOUSE_PASSWORD:-ClickHousePassword123!}"
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: "${CLICKHOUSE_ACCESS_MANAGEMENT:-1}"
      INSTANCE_ID: "${CLICKHOUSE_INSTANCE_ID:-0}"

    ulimits:
      nofile:
        soft: 262144
        hard: 262144

    volumes:
      - clickhouse-data-${CLICKHOUSE_INSTANCE_ID:-0}:/var/lib/clickhouse
      - clickhouse-logs-${CLICKHOUSE_INSTANCE_ID:-0}:/var/log/clickhouse-server

    networks:
      ${DATA_NETWORK:-data-network}:
        aliases:
          - clickhouse
          - clickhouse-instance-${CLICKHOUSE_INSTANCE_ID:-0}

    # Host ports => internal default ports
    ports:
      - "${CLICKHOUSE_HTTP_PORT:-8123}:8123"
      - "${CLICKHOUSE_TCP_PORT:-9000}:9000"

    labels:
      # Traefik HTTP routing (optional)
      traefik.enable: "${CLICKHOUSE_TRAEFIK_ENABLED:-true}"

      traefik.http.routers.clickhouse-http.rule: "Host(`${CLICKHOUSE_HTTP_HOST:-clickhouse.local}`)"
      traefik.http.routers.clickhouse-http.entrypoints: "${TRAEFIK_HTTP_ENTRYPOINT:-web}"
      traefik.http.services.clickhouse-http.loadbalancer.server.port: "8123"

      # Observability
      prometheus.io.scrape: "true"
      prometheus.io.port: "8123"
      prometheus.io.path: "/metrics"
      loki.source: "docker"
      loki.job: "clickhouse-${CLICKHOUSE_INSTANCE_ID:-0}"

    deploy:
      resources:
        limits:
          memory: ${CLICKHOUSE_MEMORY_LIMIT:-2g}
          cpus: "${CLICKHOUSE_CPU_LIMIT:-1.0}"
        reservations:
          memory: ${CLICKHOUSE_MEMORY_RESERVATION:-1g}

    restart: unless-stopped

    healthcheck:
      test: ["CMD-SHELL", "curl -sS http://localhost:8123/ping | grep -q 'Ok' || exit 1"]
      interval: ${HEALTH_CHECK_INTERVAL:-30s}
      timeout: ${HEALTH_CHECK_TIMEOUT:-10s}
      retries: ${HEALTH_CHECK_RETRIES:-3}
      start_period: ${HEALTH_CHECK_START_PERIOD:-40s}

volumes:
  clickhouse-data-${CLICKHOUSE_INSTANCE_ID:-0}:
  clickhouse-logs-${CLICKHOUSE_INSTANCE_ID:-0}:

networks:
  data-network:
    external: true
