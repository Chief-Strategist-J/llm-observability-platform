version: "3.9"

services:
  loki:
    image: grafana/loki:latest
    container_name: loki-instance-${INSTANCE_ID}
    ports:
      - "${HTTP_PORT}:${HTTP_PORT}"
      - "${GRPC_PORT}:${GRPC_PORT}"
    environment:
      LOKI_CONFIG_USE_INGRESS: "true"
      HTTP_PORT: "${HTTP_PORT}"
      GRPC_PORT: "${GRPC_PORT}"
      INSTANCE_ID: "${INSTANCE_ID}"
    command:
      - "-config.file=/etc/loki/local-config.yaml"
    volumes:
      - ${DATA_DIR_PATH}:/loki:rw
      - ${CONFIG_FILE_PATH}:/etc/loki/local-config.yaml:ro
    deploy:
      resources:
        limits:
          memory: 512m
          cpus: "0.5"
        reservations:
          memory: 256m
    restart: unless-stopped
    networks:
      - observability-network

    labels:
      traefik.enable: "true"
      traefik.docker.network: "observability-network"
      
      traefik.http.routers.loki-${INSTANCE_ID}.rule: "Host(`loki-${INSTANCE_ID}.localhost`)"
      traefik.http.routers.loki-${INSTANCE_ID}.entrypoints: "web,websecure"
      traefik.http.routers.loki-${INSTANCE_ID}.service: "loki-${INSTANCE_ID}"
      traefik.http.routers.loki-${INSTANCE_ID}.tls: "true"
      traefik.http.routers.loki-${INSTANCE_ID}.middlewares: "auth-basic,security-headers,rate-limit"
      
      traefik.http.services.loki-${INSTANCE_ID}.loadbalancer.server.port: "3100"
      
      prometheus.io.scrape: "true"
      prometheus.io.port: "3100"
      prometheus.io.path: "/metrics"
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:${HTTP_PORT}/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

networks:
  observability-network:
    external: true
