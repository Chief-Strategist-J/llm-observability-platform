version: "3.9"

services:
  redis:
    image: redis:7-alpine
    container_name: redis-instance-${REDIS_INSTANCE_ID:-0}
    environment:
      INSTANCE_ID: "${REDIS_INSTANCE_ID:-0}"
    volumes:
      - redis-data-${REDIS_INSTANCE_ID:-0}:/data
    networks:
      - ${DATA_NETWORK:-data-network}

    # Keep port for internal cache access (NOT routed through Traefik)
    ports:
      - "${REDIS_PORT:-6379}:6379"

    # NO Traefik labels (internal service only)
    labels:
      traefik.enable: "false"
      
      # Observability only
      prometheus.io.scrape: "true"
      prometheus.io.port: "9121"
      prometheus.io.path: "/metrics"
      loki.source: "docker"
      loki.job: "redis-${REDIS_INSTANCE_ID:-0}"
    
    command:
      - "redis-server"
      - "--maxmemory"
      - "${REDIS_MAXMEMORY:-256mb}"
      - "--maxmemory-policy"
      - "${REDIS_MAXMEMORY_POLICY:-allkeys-lru}"
      - "--databases"
      - "${REDIS_DATABASES:-16}"
      - "--port"
      - "${REDIS_PORT:-6379}"
    
    deploy:
      resources:
        limits:
          memory: ${REDIS_MEMORY_LIMIT:-256m}
          cpus: "${REDIS_CPU_LIMIT:-0.5}"
        reservations:
          memory: ${REDIS_MEMORY_RESERVATION:-128m}
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "${REDIS_PORT:-6379}", "ping"]
      interval: ${HEALTH_CHECK_INTERVAL:-30s}
      timeout: ${HEALTH_CHECK_TIMEOUT:-10s}
      retries: ${HEALTH_CHECK_RETRIES:-3}
      start_period: 10s

volumes:
  redis-data-${REDIS_INSTANCE_ID:-0}:

networks:
  data-network:
    external: true
