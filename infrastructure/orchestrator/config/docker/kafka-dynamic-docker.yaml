version: "3.9"

services:
  kafka:
    image: apache/kafka:4.1.1
    container_name: kafka-instance-${KAFKA_INSTANCE_ID:-0}
    environment:
      CLUSTER_ID: "${KAFKA_CLUSTER_ID:-MkU3OEVBNTcwNTJENDM2Qk}"
      KAFKA_PROCESS_ROLES: "broker,controller"
      KAFKA_NODE_ID: "${KAFKA_INSTANCE_ID:-0}"
      KAFKA_LISTENERS: "PLAINTEXT://0.0.0.0:${KAFKA_BROKER_PORT:-9093},CONTROLLER://0.0.0.0:${KAFKA_CONTROLLER_PORT:-19093}"
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://kafka-instance-${KAFKA_INSTANCE_ID:-0}:${KAFKA_BROKER_PORT:-9093}"
      KAFKA_CONTROLLER_QUORUM_VOTERS: "${KAFKA_INSTANCE_ID:-0}@kafka-instance-${KAFKA_INSTANCE_ID:-0}:${KAFKA_CONTROLLER_PORT:-19093}"
      KAFKA_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: "1"
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: "1"
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: "1"
      KAFKA_LOG_DIRS: "/var/lib/kafka/data"
      KAFKA_NUM_NETWORK_THREADS: "3"
      KAFKA_NUM_IO_THREADS: "8"
      INSTANCE_ID: "${KAFKA_INSTANCE_ID:-0}"
    volumes:
      - kafka-data-${KAFKA_INSTANCE_ID:-0}:/var/lib/kafka/data
    networks:
      - ${MESSAGING_NETWORK:-messaging-network}
      - ${OBSERVABILITY_NETWORK:-observability-network}

    ports:
      - "${KAFKA_BROKER_PORT:-9093}:${KAFKA_BROKER_PORT:-9093}"
      - "${KAFKA_CONTROLLER_PORT:-19093}:${KAFKA_CONTROLLER_PORT:-19093}"

    labels:
      traefik.enable: "false"
      prometheus.io.scrape: "true"
      prometheus.io.port: "9308"
      prometheus.io.path: "/metrics"
      loki.source: "docker"
      loki.job: "kafka-${KAFKA_INSTANCE_ID:-0}"
    
    deploy:
      resources:
        limits:
          memory: ${KAFKA_MEMORY_LIMIT:-1g}
          cpus: "${KAFKA_CPU_LIMIT:-1.0}"
        reservations:
          memory: ${KAFKA_MEMORY_RESERVATION:-512m}
    
    restart: unless-stopped
    user: "0:0"
    
    healthcheck:
      test: ["CMD-SHELL", "/opt/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server localhost:${KAFKA_BROKER_PORT:-9093} || exit 1"]
      interval: ${HEALTH_CHECK_INTERVAL:-30s}
      timeout: ${HEALTH_CHECK_TIMEOUT:-10s}
      retries: 5
      start_period: 60s

volumes:
  kafka-data-${KAFKA_INSTANCE_ID:-0}:

networks:
  messaging-network:
    external: true
  observability-network:
    external: true