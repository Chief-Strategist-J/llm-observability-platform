version: "3.9"

services:
  kafka:
    image: apache/kafka:4.1.1
    container_name: kafka-instance-${INSTANCE_ID}

    environment:
      CLUSTER_ID: "MkU3OEVBNTcwNTJENDM2Qk"
      KAFKA_PROCESS_ROLES: "broker,controller"
      KAFKA_NODE_ID: "${INSTANCE_ID}"
      KAFKA_LISTENERS: "PLAINTEXT://0.0.0.0:${BROKER_PORT},CONTROLLER://0.0.0.0:${CONTROLLER_PORT}"
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://localhost:${BROKER_PORT}"
      KAFKA_CONTROLLER_QUORUM_VOTERS: "${INSTANCE_ID}@localhost:${CONTROLLER_PORT}"
      KAFKA_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: "1"
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: "1"
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: "1"
      KAFKA_LOG_DIRS: "/var/lib/kafka/data"
      KAFKA_NUM_NETWORK_THREADS: "3"
      KAFKA_NUM_IO_THREADS: "8"
      BROKER_PORT: "${BROKER_PORT}"
      CONTROLLER_PORT: "${CONTROLLER_PORT}"
      INSTANCE_ID: "${INSTANCE_ID}"
    volumes:
      - kafka-data-${INSTANCE_ID}:/var/lib/kafka/data
    networks:
      - messaging-network

    # Keep port for internal message streaming
    ports:
      - "${BROKER_PORT}:${BROKER_PORT}"
      - "${CONTROLLER_PORT}:${CONTROLLER_PORT}"

    # NO Traefik labels (internal only)
    labels:
      traefik.enable: "false"
      
      # Observability only
      prometheus.io.scrape: "true"
      prometheus.io.port: "9308"
      prometheus.io.path: "/metrics"
      loki.source: "docker"
      loki.job: "kafka-${INSTANCE_ID}"
    deploy:
      resources:
        limits:
          memory: 1g
          cpus: "1.0"
        reservations:
          memory: 512m
    restart: unless-stopped
    user: "0:0"
    healthcheck:
      test: ["CMD-SHELL", "/opt/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server localhost:${BROKER_PORT} || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

volumes:
  kafka-data-${INSTANCE_ID}:

networks:
  data-network:
    external: true
