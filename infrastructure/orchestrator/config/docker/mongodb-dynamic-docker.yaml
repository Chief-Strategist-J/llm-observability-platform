version: "3.9"

services:
  mongodb:
    image: mongo:8.0
    container_name: mongodb-instance-${INSTANCE_ID}
    environment:
      MONGO_INITDB_ROOT_USERNAME: "admin"
      MONGO_INITDB_ROOT_PASSWORD: "MongoPassword123!"
      MONGO_INITDB_DATABASE: "admin"
      MONGO_PORT: "${MONGO_PORT}"
      INSTANCE_ID: "${INSTANCE_ID}"
    command:
      - "mongod"
      - "--auth"
      - "--bind_ip_all"
      - "--wiredTigerCacheSizeGB"
      - "0.5"
    volumes:
      - mongodb-data-${INSTANCE_ID}:/data/db
      - mongodb-config-${INSTANCE_ID}:/data/configdb
    networks:
      - data-network

    # NO Traefik labels (internal only)
    labels:
      traefik.enable: "false"
      
      # Observability only
      prometheus.io.scrape: "true"
      prometheus.io.port: "9216"
      prometheus.io.path: "/metrics"
      loki.source: "docker"
      loki.job: "mongodb-${INSTANCE_ID}"
    deploy:
      resources:
        limits:
          memory: 1g
          cpus: "1.0"
        reservations:
          memory: 512m
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "mongosh --quiet --port ${MONGO_PORT} --eval \"db.adminCommand('ping')\" --username admin --password MongoPassword123! --authenticationDatabase admin || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  mongodb-data-${INSTANCE_ID}:
  mongodb-config-${INSTANCE_ID}:

networks:
  data-network:
    external: true
