version: "3.9"

services:
  mongodb:
    image: mongo:8.0
    container_name: mongodb-instance-${MONGODB_INSTANCE_ID:-0}
    environment:
      MONGO_INITDB_ROOT_USERNAME: "${MONGODB_ROOT_USERNAME:-admin}"
      MONGO_INITDB_ROOT_PASSWORD: "${MONGODB_ROOT_PASSWORD:-MongoPassword123!}"
      MONGO_INITDB_DATABASE: "${MONGODB_DATABASE:-admin}"
      INSTANCE_ID: "${MONGODB_INSTANCE_ID:-0}"
    command:
      - "mongod"
      - "--auth"
      - "--bind_ip_all"
      - "--port"
      - "${MONGODB_PORT:-27017}"
      - "--wiredTigerCacheSizeGB"
      - "0.5"
    volumes:
      - mongodb-data-0:/data/db
      - mongodb-config-0:/data/configdb
    networks:
      - data-network

    # Keep port for internal database access (NOT routed through Traefik)
    ports:
      - "${MONGODB_PORT:-27017}:${MONGODB_PORT:-27017}"

    # NO Traefik labels (internal service only)
    labels:
      traefik.enable: "false"
      
      # Observability only
      prometheus.io.scrape: "true"
      prometheus.io.port: "9216"
      prometheus.io.path: "/metrics"
      loki.source: "docker"
      loki.job: "mongodb-${MONGODB_INSTANCE_ID:-0}"
    
    deploy:
      resources:
        limits:
          memory: ${MONGODB_MEMORY_LIMIT:-1g}
          cpus: "${MONGODB_CPU_LIMIT:-1.0}"
        reservations:
          memory: ${MONGODB_MEMORY_RESERVATION:-512m}
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD-SHELL", "mongosh --quiet --port ${MONGODB_PORT:-27017} --eval \"db.adminCommand('ping')\" --username ${MONGODB_ROOT_USERNAME:-admin} --password ${MONGODB_ROOT_PASSWORD:-MongoPassword123!} --authenticationDatabase admin || exit 1"]
      interval: ${HEALTH_CHECK_INTERVAL:-30s}
      timeout: ${HEALTH_CHECK_TIMEOUT:-10s}
      retries: ${HEALTH_CHECK_RETRIES:-3}
      start_period: ${HEALTH_CHECK_START_PERIOD:-40s}

volumes:
  mongodb-data-0:
  mongodb-config-0:

networks:
  data-network:
    external: true
